<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UP! Crash Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0e17; color: white; }
        .header { display: flex; justify-content: space-between; padding: 15px; background: #1a1f2e; }
        .stats { display: flex; gap: 20px; }
        .stat { text-align: center; }
        .stat-value { font-size: 18px; font-weight: bold; }
        .stat-label { font-size: 12px; opacity: 0.7; }
        .game-area { height: 300px; position: relative; overflow: hidden; }
        .rocket { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 60px; transition: transform 0.3s; }
        .stars { position: absolute; width: 100%; height: 100%; }
        .star { position: absolute; background: white; border-radius: 50%; }
        .history { display: flex; overflow-x: auto; padding: 10px; gap: 10px; background: #141925; }
        .multiplier { padding: 8px 15px; background: #2a3142; border-radius: 20px; min-width: 80px; text-align: center; }
        .bet-button { margin: 20px; padding: 20px; background: #3b82f6; border-radius: 15px; text-align: center; font-size: 20px; font-weight: bold; }
        .bets-list { max-height: 200px; overflow-y: auto; padding: 10px; }
        .bet-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #2a3142; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #3b82f6; margin-right: 10px; }
        .bet-info { flex: 1; }
        .bet-username { font-weight: bold; }
        .bet-details { font-size: 12px; opacity: 0.7; }
        .bet-amount { font-size: 16px; font-weight: bold; }
        .cashed-out { color: #10b981; }
        .navigation { display: flex; position: fixed; bottom: 0; width: 100%; background: #1a1f2e; }
        .nav-btn { flex: 1; text-align: center; padding: 15px; font-size: 14px; }
        .nav-btn.active { color: #3b82f6; border-bottom: 3px solid #3b82f6; }
    </style>
</head>
<body>
    <div class="header">
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="onlineCount">0</div>
                <div class="stat-label">–û–Ω–ª–∞–π–Ω</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="balance">1000</div>
                <div class="stat-label">TON</div>
            </div>
        </div>
    </div>

    <div class="game-area">
        <div class="stars" id="stars"></div>
        <div class="rocket" id="rocket">üöÄ</div>
    </div>

    <div class="history" id="historyScroll">
        <div class="multiplier">–û–∂–∏–¥–∞–Ω–∏–µ</div>
    </div>

    <div class="bet-button" id="betButton">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</div>

    <div class="bets-list" id="betsList"></div>

    <div class="navigation">
        <div class="nav-btn active" data-tab="cases">–ö–µ–π—Å—ã</div>
        <div class="nav-btn" data-tab="rocket">–†–∞–∫–µ—Ç–∞</div>
        <div class="nav-btn" data-tab="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
        
        let currentMultiplier = 1.0;
        let balance = 1000;
        let hasBet = false;
        let betAmount = 0;
        let gameActive = false;
        
        function initStars() {
            const stars = document.getElementById('stars');
            for(let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.width = star.style.height = Math.random() * 3 + 'px';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animation = `move ${Math.random() * 3 + 2}s linear infinite`;
                stars.appendChild(star);
            }
        }
        
        async function sendData(action, data = {}) {
            const result = await tg.sendData(JSON.stringify({action, ...data}));
            return JSON.parse(result);
        }
        
        async function loadInitialData() {
            const data = await sendData('get_initial_data');
            updateUI(data);
        }
        
        function updateUI(data) {
            document.getElementById('onlineCount').textContent = data.online || 0;
            document.getElementById('balance').textContent = data.balance || 0;
            balance = data.balance || 0;
            currentMultiplier = data.multiplier || 1.0;
            gameActive = data.is_game_active || false;
            
            updateRocketPosition(data.multiplier);
            updateHistory(data.history || []);
            updateBetsList(data.bets || []);
            updateBetButton();
        }
        
        function updateRocketPosition(multiplier) {
            const rocket = document.getElementById('rocket');
            const maxHeight = 300;
            const progress = Math.min((multiplier - 1) / 10, 1);
            const newY = 50 - progress * 40;
            rocket.style.top = newY + '%';
            rocket.style.transform = `translate(-50%, -50%) scale(${1 + progress * 0.5})`;
        }
        
        function updateHistory(history) {
            const container = document.getElementById('historyScroll');
            container.innerHTML = '<div class="multiplier">–û–∂–∏–¥–∞–Ω–∏–µ</div>';
            history.forEach(mult => {
                const el = document.createElement('div');
                el.className = 'multiplier';
                el.textContent = mult.toFixed(2) + 'x';
                container.appendChild(el);
            });
        }
        
        function updateBetsList(bets) {
            const container = document.getElementById('betsList');
            container.innerHTML = '';
            bets.forEach(bet => {
                const item = document.createElement('div');
                item.className = 'bet-item';
                item.innerHTML = `
                    <div class="avatar"></div>
                    <div class="bet-info">
                        <div class="bet-username">${bet.username}</div>
                        <div class="bet-details">${bet.amount} TON ‚Ä¢ ${bet.current_multiplier.toFixed(2)}x</div>
                    </div>
                    <div class="bet-amount ${bet.cashed_out ? 'cashed-out' : ''}">
                        ${(bet.amount * bet.current_multiplier).toFixed(2)} TON
                    </div>
                `;
                container.appendChild(item);
            });
        }
        
        function updateBetButton() {
            const btn = document.getElementById('betButton');
            if (hasBet) {
                btn.textContent = `–ó–∞–±—Ä–∞—Ç—å ${(betAmount * currentMultiplier).toFixed(2)} TON`;
                btn.style.background = '#10b981';
            } else if (gameActive) {
                btn.textContent = '–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É';
                btn.style.background = '#3b82f6';
            } else {
                btn.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞...';
                btn.style.background = '#6b7280';
            }
        }
        
        document.getElementById('betButton').onclick = async () => {
            if (!hasBet && gameActive) {
                betAmount = 10;
                const result = await sendData('place_bet', {amount: betAmount});
                if (result.success) {
                    hasBet = true;
                    balance = result.balance;
                    updateBetButton();
                }
            } else if (hasBet) {
                const result = await sendData('cash_out');
                if (result.success) {
                    hasBet = false;
                    balance = result.balance;
                    updateBetButton();
                }
            }
        };
        
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            };
        });
        
        async function gameLoop() {
            while(true) {
                if (gameActive || hasBet) {
                    const data = await sendData('get_update');
                    updateUI(data);
                }
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }
        
        initStars();
        loadInitialData();
        gameLoop();
        
        const style = document.createElement('style');
        style.textContent = `
            @keyframes move {
                from { transform: translateY(0); }
                to { transform: translateY(300px); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
